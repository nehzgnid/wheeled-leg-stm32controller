# STM32F407 多功能嵌入式控制系统

## 项目概述

这是一个基于STM32F407VET6的多功能嵌入式控制系统，集成了GPIO控制、IMU传感器读取、PCA9685舵机驱动、多路电机控制和UART通信功能。项目使用STM32CubeMX生成基础框架，配合Keil MDK-ARM开发环境，采用FreeRTOS实现多任务并发执行。

## 硬件接口配置

- **主控芯片**: STM32F407VET6
- **系统时钟**: 168MHz
- **GPIO接口**: PB12用于GPIO测试输出
- **电机控制接口**:
  - 电机1: PD13(1)和PD13(2)用于控制电机方向
  - 电机2: PD10(1)和PD11(2)用于控制电机方向
  - 电机3: PD8(1)和PD9(2)用于控制电机方向
  - 电机4: PD14(1)和PD15(2)用于控制电机方向
- **编码器接口**:
  - 电机1: TIM1 (PE9/PE11) 用于读取电机编码器数据
  - 电机2: TIM2 (PA7/PB3) 用于读取电机编码器数据
  - 电机3: TIM3 (PA6/PA7) 用于读取电机编码器数据
  - 电机4: TIM8 (PC6/PC7) 用于读取电机编码器数据
- **I2C1接口**: PB6(SCL)/PB7(SDA) 用于MPU6050传感器通信
- **I2C2接口**: PB10(SCL)/PB11(SDA) 用于PCA9685舵机驱动通信
- **UART1接口**: PA9(TX)/PA10(RX) 用于发送电机转速数据到PC
- **UART4接口**: PC10(TX)/PC11(RX) 用于调试信息输出
- **UART5接口**: PC12(TX)/PD2(RX) 用于与上位机通信

## 功能模块

### 1. GPIO控制模块
- **功能**: 控制PB12引脚输出
- **任务**: GPIO_Task (优先级: osPriorityNormal,调试时才开启)
- **特性**: 持续输出控制信号

### 2. IMU传感器模块
- **传感器**: MPU6050六轴传感器
- **功能**: 读取加速度计、陀螺仪和温度数据
- **任务**: Imu_Task (优先级: osPriorityLow)
- **频率**: 每100ms读取一次数据
- **通信**: 通过I2C1接口与传感器通信

### 3. PCA9685舵机驱动模块
- **驱动芯片**: PCA9685 16路PWM控制器
- **功能**: 控制16路舵机，支持0-180度精确控制
- **任务**: PCA9685_Task (优先级: osPriorityLow)
- **频率**: 50Hz PWM频率（舵机标准频率）
- **通信**: 通过I2C2接口与驱动芯片通信
- **特性**: 支持平滑转动和速度控制

### 4. 多路电机控制模块
- **功能**: 控制4路电机，支持多种运动模式
- **任务**:
  - MotorSpeedTask (4个实例): 分别监测4个电机的速度和方向
  - MotorCtrl_Task (1个实例): 根据上位机命令控制4个电机的方向和制动
- **编码器接口**:
  - TIM1, TIM2, TIM3, TIM8用于读取各电机编码器数据
- **控制接口**:
  - 4组GPIO引脚用于控制各电机方向和制动
- **特性**:
  - 实时读取各电机转速和方向
  - 支持多种控制模式
  - 可独立控制每个电机

### 5. UART通信模块
- **接口**: UART1, UART4, UART5
- **功能**: 串口数据收发，支持100Hz频率通信
- **任务**: UART_Task1, Jetson_Task (优先级: osPriorityLow)
- **波特率**: 115200
- **特性**: 实时输出系统状态、传感器数据和电机数据

## 通信协议

### 舵机控制协议
- **命令格式**: `SERVO,<servo_id>,<angle>,<duration>\n`
- **示例**: `SERVO,0,90,1000\n` - 控制0号舵机转到90度，用时1000ms
- **参数说明**:
  - `servo_id`: 舵机ID (0-15)
  - `angle`: 目标角度 (0-180度)
  - `duration`: 执行时间 (毫秒)

### 电机控制协议
- **命令格式**: `MOTOR,<motor_id>,<command>,<speed_rpm>\n`
- **示例**: `MOTOR,0,3,50.5\n` - 控制0号电机正转，转速50.5 RPM
- **参数说明**:
  - `motor_id`: 电机ID (0-3)
  - `command`: 控制命令 (0=慢刹车, 1=快刹车, 2=反转, 3=正转)
  - `speed_rpm`: 目标转速 (RPM)

### 姿态回传协议
- **命令格式**: `POSE,<servo0>,<servo1>,...,<servo15>,<timestamp>,<accel_x>,<accel_y>,<accel_z>,<gyro_x>,<gyro_y>,<gyro_z>,<temperature>,<dir1>,<dir2>,<dir3>,<dir4>,<rpm1>,<rpm2>,<rpm3>,<rpm4>\n`
- **示例**: `POSE,90,90,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1234567890,0.01,0.02,-0.98,0.1,0.2,0.3,25.5,1,0,-1,1,50.5,0.0,-30.2,45.8\n`
- **参数说明**:
  - 前16个值: 16个舵机的角度值
  - 第17个值: 时间戳
  - 中间7个值: IMU数据 (加速度、角速度、温度)
  - 接下来4个值: 4个电机的转向 (-1=反转, 0=停止, 1=正转)
  - 最后4个值: 4个电机的转速 (RPM)

### 电机转速数据协议 (UART1)(调试时开启)
- **数据格式**: 4字节IEEE 754浮点数，直接传输RPM值的内存表示
- **说明**: 通过UART1发送电机转速数据到PC，每4字节代表一个浮点数RPM值

## 软件架构
- **实时操作系统**: FreeRTOS
- **开发环境**: STM32CubeMX + Keil MDK-ARM
- **HAL库**: STM32F4xx HAL库
- **任务调度**: 多任务并发执行，优先级合理分配
- **任务列表**:
  - GPIO_Task: 控制GPIO输出
  - UART_Task: 处理UART通信
  - Imu_Task: 读取IMU传感器数据
  - PCA9685_Task: 控制舵机
  - Jetson_Task: 与上位机通信
  - MotorSpeedTask (4个实例): 分别读取4个电机编码器数据并计算转速
  - MotorCtrl_Task: 根据上位机命令控制4个电机方向和制动

## 系统特性
- **多任务并发**: 多个独立任务同时运行，互不干扰
- **独立通信**: I2C1和I2C2完全独立，避免总线冲突
- **实时响应**: 传感器数据和电机数据实时更新
- **状态监控**: 通过UART实时输出系统运行状态和电机状态
- **扩展性强**: 模块化设计，便于功能扩展
- **高效通信**: 支持100Hz频率的舵机控制、姿态回传和电机数据传输
- **电机控制**: 支持多种电机运动模式（正转、反转、慢刹车、快刹车）
- **多路控制**: 可独立控制4路电机，每路电机具有独立的编码器反馈和控制接口

## 应用场景
适用于轮式腿式机器人控制器、多自由度机械臂控制、姿态感知系统、多电机控制系统等应用场景。

## 硬件连接
- MPU6050: VCC->3.3V, GND->GND, SCL->PB6, SDA->PB7
- PCA9685: VCC->5V, GND->GND, SCL->PB10, SDA->PB11
- 电机编码器1: 连接到TIM1 
- 电机编码器2: 连接到TIM2 
- 电机编码器3: 连接到TIM3 
- 电机编码器4: 连接到TIM8
- 电机控制1: PD12和PD13用于控制电机1方向
- 电机控制2: PD10和PD11用于控制电机2方向
- 电机控制3: PD8和PD9用于控制电机3方向
- 电机控制4: PD14和PD15用于控制电机4方向
- 舵机: 连接到PCA9685的OUT0-OUT15输出端口
- 串口: 连接到PC或其他串口设备
- UART1: 连接到PC用于接收电机转速数据