# STM32F407 多功能嵌入式控制系统

## 项目概述

这是一个基于STM32F407VET6的多功能嵌入式控制系统，集成了GPIO控制、IMU传感器读取、PCA9685舵机驱动和UART通信功能。项目使用STM32CubeMX生成基础框架，配合Keil MDK-ARM开发环境，采用FreeRTOS实现多任务并发执行。

## 舵机限幅
- **0**:0-160
- **1**:45-180
- **2**:0-100
- **3**:0-130

## 硬件接口配置

- **主控芯片**: STM32F407VET6
- **系统时钟**: 168MHz
- **GPIO接口**: PB12用于GPIO测试输出
- **I2C1接口**: PB6(SCL)/PB7(SDA) 用于MPU6050传感器通信
- **I2C2接口**: PB10(SCL)/PB11(SDA) 用于PCA9685舵机驱动通信
- **UART4接口**: PA0(TX)/PA1(RX) 用于串口通信
- **UART5接口**: PC12(TX)/PD2(RX) 用于与上位机通信

## 功能模块

### 1. GPIO控制模块
- **功能**: 控制PB12引脚输出
- **任务**: GPIO_Task (优先级: osPriorityNormal)
- **特性**: 持续输出控制信号

### 2. IMU传感器模块
- **传感器**: MPU6050六轴传感器
- **功能**: 读取加速度计、陀螺仪和温度数据
- **任务**: Imu_Task (优先级: osPriorityLow)
- **频率**: 每100ms读取一次数据
- **通信**: 通过I2C1接口与传感器通信

### 3. PCA9685舵机驱动模块
- **驱动芯片**: PCA9685 16路PWM控制器
- **功能**: 控制16路舵机，支持0-180度精确控制
- **任务**: PCA9685_Task (优先级: osPriorityLow)
- **频率**: 50Hz PWM频率（舵机标准频率）
- **通信**: 通过I2C2接口与驱动芯片通信
- **特性**: 支持平滑转动和速度控制

### 4. UART通信模块
- **接口**: UART4, UART5
- **功能**: 串口数据收发，支持100Hz频率通信
- **任务**: Jetson_Task (优先级: osPriorityLow)
- **波特率**: 115200
- **特性**: 实时输出系统状态和传感器数据

## 通信协议

### 舵机控制协议
- **命令格式**: `SERVO,<servo_id>,<angle>,<duration>\n`
- **示例**: `SERVO,0,90,1000\n` - 控制0号舵机转到90度，用时1000ms
- **参数说明**:
  - `servo_id`: 舵机ID (0-15)
  - `angle`: 目标角度 (0-180度)
  - `duration`: 执行时间 (毫秒)

### 姿态回传协议
- **命令格式**: `POSE,<servo0>,<servo1>,...,<servo15>,<timestamp>,<accel_x>,<accel_y>,<accel_z>,<gyro_x>,<gyro_y>,<gyro_z>,<temperature>\n`
- **示例**: `POSE,90,90,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1234567890,0.01,0.02,-0.98,0.1,0.2,0.3,25.5\n`
- **参数说明**:
  - 前16个值: 16个舵机的角度值
  - 第17个值: 时间戳
  - 后7个值: IMU数据 (加速度、角速度、温度)

## 软件架构
- **实时操作系统**: FreeRTOS
- **开发环境**: STM32CubeMX + Keil MDK-ARM
- **HAL库**: STM32F4xx HAL库
- **任务调度**: 多任务并发执行，优先级合理分配

## 系统特性
- **多任务并发**: 四个独立任务同时运行，互不干扰
- **独立通信**: I2C1和I2C2完全独立，避免总线冲突
- **实时响应**: 传感器数据实时更新，舵机平滑控制
- **状态监控**: 通过UART实时输出系统运行状态
- **扩展性强**: 模块化设计，便于功能扩展
- **高效通信**: 支持100Hz频率的舵机控制和姿态回传

## 应用场景
适用于轮式腿式机器人控制器、多自由度机械臂控制、姿态感知系统等应用场景。

## 硬件连接
- MPU6050: VCC->3.3V, GND->GND, SCL->PB6, SDA->PB7
- PCA9685: VCC->5V, GND->GND, SCL->PB10, SDA->PB11
- 舵机: 连接到PCA9685的OUT0-OUT15输出端口
- 串口: 连接到PC或其他串口设备